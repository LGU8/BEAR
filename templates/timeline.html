{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/timeline.css' %}">
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
{% endblock %}

{% block content %}

<!-- jQuery & Datepicker -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.ko.min.js"></script>

<!-- (1) ì£¼ê°„ ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„ -->
<section class="timeline-section">
  <div class="timeline-card">

    <!-- âœ… í—¤ë”ë¥¼ 2ì¤„ êµ¬ì¡°ë¡œ: ì œëª© â†’ ë‚ ì§œì„ íƒ -->
    <div class="timeline-card-head timeline-card-head--stack">
      <h4 class="timeline-title">ê°ì • ë³€í™” ìš”ì•½</h4>

      <!-- âœ… Datepicker bar (ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ + í™”ì‚´í‘œ) -->
      <div class="timeline-datebar" id="week-picker-trigger">
        <span class="timeline-datebar-icon" aria-hidden="true">ğŸ“…</span>

        <!-- inputì€ íˆ¬ëª…/ê²¹ì³ë‘ê³ , ë³´ì—¬ì§€ëŠ” í…ìŠ¤íŠ¸ëŠ” spanìœ¼ë¡œ ì œì–´ -->
        <span class="timeline-datebar-text" id="week-picker-label">
          {{ week_start }} ~ {{ week_end }}
        </span>

        <span class="timeline-datebar-caret" aria-hidden="true">â–¾</span>

        <!-- ì‹¤ì œ datepicker input (ë³´ì´ì§€ ì•Šê²Œ ê¹”ì•„ë‘ ) -->
        <input
          type="text"
          id="week-picker"
          class="timeline-week-hidden-input"
          readonly
          aria-label="ì£¼ê°„ ì‹œì‘ì¼ ì„ íƒ"
        >
      </div>
    </div>

    <!-- âœ… í° ë°°ê²½ íŒ¨ë„ ìœ„ì— ê·¸ë˜í”„ -->
    <div class="timeline-chart-panel">
      <canvas id="weeklyEmotionChart"></canvas>
    </div>

  </div>
</section>

<!-- (2) ML ë¶€ì • ê°ì • ì˜ˆì¸¡ ê²°ê³¼ -->
<section class="timeline-section">
  <div class="timeline-card">
    <div class="timeline-card-head">
      <h4 class="timeline-title">ë¶€ì • ê°ì • ì˜ˆì¸¡</h4>
    </div>

    <div class="prediction-box">
      <p>
        ì˜ˆì¸¡ ê²°ê³¼:
        <strong>{{ risk_label }}</strong>
        (score: {{ risk_score }})
      </p>
    </div>
  </div>
</section>

<!-- (3) LLM ë©˜íŠ¸ -->
<section class="timeline-section">
  <div class="timeline-card">
    <div class="timeline-card-head">
      <h4 class="timeline-title">í–‰ë™ ì¶”ì²œ</h4>
    </div>

    <div class="llm-box">
      <p>{{ llm_ment }}</p>
    </div>
  </div>
</section>

<!-- âœ… Chart data -->
<script id="weeklyEmotionData" type="application/json">
{{ chart_json|safe }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/timeline.js' %}"></script>

<!-- âœ… Week Datepicker Script -->
<script>
$(function () {
    const weekStartStr = "{{ week_start }}"; // YYYY.MM.DD
    const weekEndStr   = "{{ week_end }}";

    // ë¼ë²¨ ì´ˆê¸° í‘œì‹œ
    $('#week-picker-label').text(`${weekStartStr} ~ ${weekEndStr}`);

    const today = new Date();
    const maxStart = new Date();
    maxStart.setDate(today.getDate() - 6); // (A-1) ì˜¤ëŠ˜-6ê¹Œì§€ë§Œ ì‹œì‘ ê°€ëŠ¥

    $('#week-picker').datepicker({
        format: 'yyyy-mm-dd',
        language: 'ko',
        autoclose: true,
        endDate: maxStart,
        todayHighlight: false
    }).on('changeDate', function (e) {
        const startDate = e.date;
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);

        const fmt = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}${m}${day}`;
        };

        // ë¼ë²¨(í™”ë©´í‘œì‹œ)ì€ YYYY.MM.DD ~ YYYY.MM.DD í˜•íƒœ ìœ ì§€
        const fmtLabel = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}.${m}.${day}`;
        };
        $('#week-picker-label').text(`${fmtLabel(startDate)} ~ ${fmtLabel(endDate)}`);

        const startParam = fmt(startDate);
        const endParam = fmt(endDate);

        // í™”ë©´ ê°±ì‹ (ê°™ì€ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë§Œ ë°”ë€ŒëŠ” ëŠë‚Œ)
        window.location.search = `?start=${startParam}&end=${endParam}`;
    });

    // âœ… ë°” ì „ì²´ í´ë¦­ ì‹œ ë‹¬ë ¥ ì—´ê¸°
    $('#week-picker-trigger').on('click', function () {
        $('#week-picker').datepicker('show');
    });
});
</script>


{% endblock %}
