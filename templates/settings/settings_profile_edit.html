{% extends "settings/settings_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/settings/settings_base.css' %}">
<link rel="stylesheet" href="{% static 'css/settings/settings_s2.css' %}">
<link rel="stylesheet" href="{% static 'css/settings/settings_badge_picker.css' %}">
{% endblock %}

{% block main_area %}
<section class="settings-page">

  <article class="settings-card edit-card">
    <form id="s2Form" method="post" novalidate>
      {% csrf_token %}

      <div class="edit-header">
        <a class="back-btn" href="{% url 'settings_app:settings_account' %}" aria-label="back">←</a>
        <div class="edit-title">개인정보 수정</div>
        <div class="edit-header-spacer"></div>
      </div>

      <!-- ✅ 프로필 배지 (클릭 => 모달 오픈) -->
      <div class="profile-edit-avatar">
        <button type="button" id="badgeOpenBtn" class="avatar-btn" aria-label="badge picker open">
          <div class="profile-avatar-wrap lg">
            <img
              id="profileBadgeImg"
              class="profile-avatar lg"
              src="{% static profile_badge_img %}"
              alt="profile badge"
            />
            <span class="avatar-edit" aria-hidden="true">
              <img class="edit-ico" src="{% static 'icons_img/dslr-camera.png' %}" alt="edit">
            </span>
          </div>
        </button>

        <div class="profile-edit-hint">배지를 눌러 프로필 캐릭터를 바꿀 수 있어요</div>
      </div>

      <!-- ✅ 서버 저장용 hidden -->
      <input
        type="hidden"
        id="selected_badge_id"
        name="selected_badge_id"
        value="{{ selected_badge_id|default:'' }}"
      />

      <!-- 닉네임 -->
      <div class="form-block">
        <label class="form-label" for="nickname">닉네임</label>
        <input
          id="nickname"
          name="nickname"
          class="form-input"
          type="text"
          inputmode="text"
          autocomplete="nickname"
          value="{{ nickname|default:'' }}"
          placeholder="닉네임"
          maxlength="20"
        >
        <div class="form-help">한글/영문/숫자/밑줄(_)만 가능</div>
      </div>

      <!-- 생년월일 -->
      <div class="form-block">
        <label class="form-label" for="birth_date_ui">생년월일</label>

        <div class="form-row">
          <input
            id="birth_date_ui"
            name="birth_date_ui"
            class="form-input"
            type="date"
            value="{{ birth_dt|default:''|slice:':4' }}-{{ birth_dt|default:''|slice:'4:6' }}-{{ birth_dt|default:''|slice:'6:8' }}"
          >
          <span class="form-suffix">▼</span>
        </div>

        <input type="hidden" id="birth_dt" name="birth_dt" value="{{ birth_dt|default:'' }}">
      </div>

      <!-- 성별 -->
      <div class="form-block">
        <label class="form-label">성별</label>

        <div class="seg-toggle" role="group" aria-label="gender toggle">
          <button
            type="button"
            class="seg-toggle-btn {% if gender == 'F' %}is-active{% endif %}"
            data-value="F"
            aria-pressed="{% if gender == 'F' %}true{% else %}false{% endif %}"
          >여자</button>

          <button
            type="button"
            class="seg-toggle-btn {% if gender == 'M' %}is-active{% endif %}"
            data-value="M"
            aria-pressed="{% if gender == 'M' %}true{% else %}false{% endif %}"
          >남자</button>
        </div>

        <input type="hidden" id="gender" name="gender" value="{{ gender|default:'' }}">
      </div>

      <!-- 키 -->
      <div class="form-block">
        <label class="form-label" for="height_cm">키</label>
        <div class="form-row">
          <input
            id="height_cm"
            name="height_cm"
            class="form-input"
            type="number"
            inputmode="numeric"
            min="90"
            max="250"
            step="1"
            value="{{ height_cm|default_if_none:'' }}"
            placeholder="키"
          >
          <span class="form-suffix">cm</span>
        </div>
      </div>

      <!-- 몸무게 -->
      <div class="form-block">
        <label class="form-label" for="weight_kg">몸무게</label>
        <div class="form-row">
          <input
            id="weight_kg"
            name="weight_kg"
            class="form-input"
            type="number"
            inputmode="numeric"
            min="20"
            max="300"
            step="1"
            value="{{ weight_kg|default_if_none:'' }}"
            placeholder="몸무게"
          >
          <span class="form-suffix">kg</span>
        </div>
      </div>

      <!-- 에러 텍스트 -->
      <div id="s2Error" class="form-error" aria-live="polite">
        {% if error %}{{ error }}{% endif %}
      </div>

      <div class="edit-footer">
        <button id="saveBtn" class="save-btn" type="submit" disabled>저장</button>
      </div>
    </form>
  </article>

</section>

<!-- ✅ Badge Picker Modal -->
<div id="badgeModal" class="badge-modal" aria-hidden="true">
  <div class="badge-modal__backdrop" data-close="1"></div>

  <div class="badge-modal__panel" role="dialog" aria-modal="true" aria-label="badge picker">
    <div class="badge-modal__head">
      <div class="badge-modal__title">프로필 캐릭터 선택</div>
      <button type="button" class="badge-modal__close" data-close="1" aria-label="close">×</button>
    </div>

    <div class="badge-modal__tabs">
      <button type="button" class="badge-tab is-active" data-tab="F">식단(Food)</button>
      <button type="button" class="badge-tab" data-tab="E">감정(Emotion)</button>
    </div>

    <div class="badge-modal__body">
      <!-- Food -->
      <div class="badge-grid" data-pane="F">
        {% for b in picker_items %}
          {% if b.category == "F" %}
          <button
            type="button"
            class="badge-item {% if b.locked %}is-locked{% endif %}"
            data-id="{{ b.badge_id }}"
            data-img="{{ b.img_url }}"
            data-title="{{ b.title|escape }}"
            data-hint="{{ b.hint|escape }}"
            {% if b.locked %}disabled{% endif %}
          >
            <img src="{{ b.img_url }}" alt="{{ b.badge_id }}">
            <div class="badge-item__meta">
              <div class="badge-item__title">{{ b.title }}</div>
              <div class="badge-item__hint">{{ b.hint }}</div>
            </div>
          </button>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Emotion -->
      <div class="badge-grid is-hidden" data-pane="E">
        {% for b in picker_items %}
          {% if b.category == "E" %}
          <button
            type="button"
            class="badge-item {% if b.locked %}is-locked{% endif %}"
            data-id="{{ b.badge_id }}"
            data-img="{{ b.img_url }}"
            data-title="{{ b.title|escape }}"
            data-hint="{{ b.hint|escape }}"
            {% if b.locked %}disabled{% endif %}
          >
            <img src="{{ b.img_url }}" alt="{{ b.badge_id }}">
            <div class="badge-item__meta">
              <div class="badge-item__title">{{ b.title }}</div>
              <div class="badge-item__hint">{{ b.hint }}</div>
            </div>
          </button>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="badge-modal__foot">
      <div class="badge-modal__help">획득한 배지만 선택할 수 있어요.</div>
      <button type="button" id="badgeApplyBtn" class="badge-apply-btn" disabled>적용</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/settings/settings_s2.js' %}"></script>
<script src="{% static 'js/settings/settings_badge_picker.js' %}"></script>
{% endblock %}
