{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/report_style.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.ko.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 일일 / 주간 탭 -->
<div class="bear-tabs-bar report-period-tabs">
  <div class="bear-tabs-inner">
    <div class="bear-tab-box period-tab active">
      <a href="/report_daily" class="bear-tab-text">일일</a>
    </div>
    <div class="bear-tab-box period-tab">
      <a href="/report_weekly" class="bear-tab-text">주간</a>
    </div>
  </div>
</div>

<!-- 날짜 선택 -->
<div class="report-datepicker">
  <input type="text" id="date-picker" class="form-control" placeholder="날짜 선택">
</div>

<script>
$(function () {
  const defaultDateStr = "{{ selected_date }}";

  $('#date-picker').datepicker({
    format: 'yyyy-mm-dd',
    language: 'ko',
    autoclose: true,
    endDate: new Date(),
    todayHighlight: false
  });

  $('#date-picker').datepicker('update', defaultDateStr);
});
</script>

<!-- =========================
     오늘의 요약 카드
     ========================= -->
<div class="summary-card feedback-summary-card">
  <div class="summary-title">
    <span>오늘의 요약</span>
  </div>

  <div class="feedback-card">
    <img class="feedback-ico" src="{% static 'icons_img/bear_report.png' %}" alt="bear feedback">
    <div class="feedback-text">
      오늘은 조금 힘들었겠지만, 긍정적인 기운이 더 많았어. 단백질이 풍부한 식사로 힘을 보충해보자!
      햇살 가득한 저녁이 너를 따뜻하게 감싸줬을 거야.
    </div>
  </div>
</div>

<!-- =========================
     영양소 카드
     ========================= -->
<div class="summary-card nutrition-card">
  <div class="summary-title">
    <span>영양소</span>
  </div>

  <!-- 토글 버튼 -->
  <div class="nutrition-toggle">
    <button class="toggle-btn active" data-target="summary">요약</button>
    <span class="divider">|</span>
    <button class="toggle-btn" data-target="detail">자세히</button>
  </div>

  <!-- 요약 내용 (기본 노출) -->
  <div class="nutrition-content summary-content">
      <div class="nut-row">
        <div class="nut-title">칼로리</div>
        <div class="nut-text">1000 / 2000 kcal</div>
        <div class="nut-bar"><span style="width:40%"></span></div>
      </div>

      <div class="nut-row">
        <div class="nut-title">탄수화물</div>
        <div class="nut-text">180 / 300 g</div>
        <div class="nut-bar"><span style="width:60%"></span></div>
      </div>

      <div class="nut-row">
        <div class="nut-title">단백질</div>
        <div class="nut-text">90 / 120 g</div>
        <div class="nut-bar"><span style="width:75%"></span></div>
      </div>

      <div class="nut-row">
        <div class="nut-title">지방</div>
        <div class="nut-text">40 / 60 g</div>
        <div class="nut-bar"><span style="width:66%"></span></div>
      </div>
  </div>

  <!-- 자세히 내용 (기본 숨김) -->
  <div class="nutrition-content detail-content">
      <!-- 식사 시간 선택 -->
      <div class="meal-toggle">
        <img src="/static/icons_img/morning.png" class="meal-btn active" data-meal="morning" alt="아침">
        <img src="/static/icons_img/lunch.png" class="meal-btn" data-meal="lunch" alt="점심">
        <img src="/static/icons_img/dinner.png" class="meal-btn" data-meal="dinner" alt="저녁">
      </div>

      <!-- 메뉴명 표시 -->
      <div class="meal-menu">
        <div class="meal-menu-title">메뉴</div>
        <div class="meal-menu-text">계란후라이, 토스트</div>
      </div>

    <!-- 칼로리 + 탄단지 그래프 -->
    <div class="meal-nutrition-row">
      <!-- 왼쪽: 칼로리 텍스트 -->
      <div class="meal-calorie-text">
        520 kcal
      </div>

      <!-- 오른쪽: 가로 누적 막대 -->
      <div class="meal-macro-chart">
        <canvas id="macroChart"></canvas>
      </div>
    </div>

  </div>
</div>



<!-- =========================
     기분 카드
     ========================= -->
<div class="summary-card mood-card">
  <div class="summary-title">
    <span>기분</span>
  </div>

  <div class="mood-chart-placeholder">
    Donut Chart
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    /*  요약 / 자세히 토글 */
    document.querySelectorAll('.nutrition-toggle .toggle-btn')
      .forEach(button => {
        button.addEventListener('click', () => {

          document.querySelectorAll('.nutrition-toggle .toggle-btn')
            .forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');

          const target = button.dataset.target;

          document.querySelector('.summary-content').style.display =
            target === 'summary' ? 'block' : 'none';
          document.querySelector('.detail-content').style.display =
            target === 'detail' ? 'block' : 'none';
        });
      });


    /*  자세히 - 더미 데이터  */
    const mealMacroData = {
      morning: { carb: 260, protein: 120, fat: 140, kcal: 520 },
      lunch:   { carb: 300, protein: 180, fat: 160, kcal: 640 },
      dinner:  { carb: 200, protein: 220, fat: 180, kcal: 600 }
    };


    /* 가로 누적 막대그래프 */
    let macroChart = null;

    function renderMacroChart(data) {
      const canvas = document.getElementById("macroChart");
      if (!canvas) return;

      const ctx = canvas.getContext("2d");

      if (macroChart) macroChart.destroy();

      macroChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["macro"],
          datasets: [
            { data: [data.carb],    backgroundColor: "#FFD07C", stack: "macro" },
            { data: [data.protein], backgroundColor: "#FFE2B6", stack: "macro" },
            { data: [data.fat],     backgroundColor: "#FFB845", stack: "macro" }
          ]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { stacked: true, display: false },
            y: { stacked: true, display: false }
          }
        }
      });
    }


    /* meal-btn 클릭 + 초기 상태 */

    // 초기 상태: 아침
    renderMacroChart(mealMacroData.morning);
    document.querySelector('.meal-calorie-text').textContent = "520 kcal";

    document.querySelectorAll('.meal-btn').forEach(btn => {
      btn.addEventListener('click', () => {

        document.querySelectorAll('.meal-btn')
          .forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const meal = btn.dataset.meal;

        document.querySelector('.meal-calorie-text').textContent =
          `${mealMacroData[meal].kcal} kcal`;

        renderMacroChart(mealMacroData[meal]);
      });
    });

  });
</script>


{% endblock %}
