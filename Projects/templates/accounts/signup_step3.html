<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원가입 - Step 3</title>
  {% load static %}
  <style>
    body {
      background-color: #FFF9F0;
      margin: 0; padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
      min-height: 100dvh;
    }

    .header-container { width: 100%; max-width: 450px; padding: 40px 20px 20px; text-align: center; }
    .bear-logo { width: 100px; height: auto; margin-bottom: 20px; }
    .progress-container { width: 80%; height: 12px; background-color: #F0EAD6; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    .progress-bar { width: 75%; height: 100%; background-color: #F38218; border-radius: 10px; }

    .card {
      background-color: white; width: 95%; max-width: 520px;
      border-radius: 15px;
      padding: 26px 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-top: 10px; box-sizing: border-box; margin-bottom: 40px;
    }

    .helper {
      font-size: 0.9rem;
      font-weight: 800;
      color: #F38218;
      margin-bottom: 14px;
      text-align: right;
    }

    .q-row {
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 14px 12px;
      display: grid;
      grid-template-columns: 50px 1fr;
      gap: 12px;
      align-items: center;
      background: #FFF;
      margin-bottom: 12px;
    }

    .q-ico {
      width: 46px; height: 46px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    .q-title {
      font-size: 0.95rem;
      font-weight: 800;
      color: #333;
      line-height: 1.35;
      margin-bottom: 10px;
    }

    .tri {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      align-items: center;
    }

    .tri-btn {
      height: 38px;
      border-radius: 12px;
      border: 2px solid rgba(243,130,24,0.55);
      background: #fff;
      cursor: pointer;
      font-weight: 800;
      font-size: 0.92rem;
      color: #333;
      opacity: 0.5;
      transition: transform 0.08s, opacity 0.12s, background-color 0.12s;
      box-sizing: border-box;
    }

    .tri-btn:active { transform: translateY(1px); }

    .tri-btn.is-on {
      background: #F38218;
      color: #fff;
      opacity: 1;
      border-color: #F38218;
    }

    .btn-group { display: flex; gap: 10px; margin-top: 18px; }
    .btn-prev {
      background-color: #F38218; color: white; border: none;
      padding: 15px; border-radius: 12px; cursor: pointer; flex: 1;
      font-weight: 800; font-size: 1rem; box-sizing: border-box;
    }
    .btn-next {
      background-color: #F38218; color: white; border: none;
      padding: 15px; border-radius: 12px; cursor: pointer; flex: 2;
      font-weight: 800; font-size: 1rem; box-sizing: border-box;
    }
    .btn-next:disabled { background-color: #ccc; cursor: not-allowed; }

    .error {
      margin: 10px 0 0;
      font-size: 0.9rem;
      font-weight: 800;
      color: #e74c3c;
    }

    /* ─────────────────────────────
       모바일/태블릿 반응형 + 안정화 패치
       ───────────────────────────── */
    @media (max-width: 768px) {
      html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
      *, *::before, *::after { box-sizing: border-box; }
      img, video, svg, canvas { max-width: 100%; height: auto; }
      input, button { max-width: 100%; }

      .header-container { padding: 32px 16px 18px; }
      .card { padding: 22px 16px; }
    }

    @media (max-width: 480px) {
      .header-container { padding: 26px 14px 16px; }
      .bear-logo { width: 92px; margin-bottom: 14px; }
      .progress-container { width: 86%; }

      .card { width: 92%; padding: 20px 14px; margin-bottom: 28px; }

      /* grid 폭 줄여서 아이콘/텍스트 깨짐 방지 */
      .q-row {
        grid-template-columns: 44px 1fr;
        gap: 10px;
        padding: 12px 10px;
      }
      .q-row > div { min-width: 0; } /* 텍스트 줄바꿈 안정화 */
      .q-ico { width: 40px; height: 40px; }

      .q-title { font-size: 0.92rem; }

      .tri { gap: 8px; }
      .tri-btn { height: 36px; font-size: 0.9rem; }

      .btn-group { gap: 8px; }
      .btn-prev, .btn-next { padding: 14px; font-size: 0.98rem; }
      .helper { text-align: left; }
    }

    @media (max-width: 360px) {
      .tri-btn { font-size: 0.88rem; }
    }
  </style>
</head>
<body>

  <div class="header-container">
    <a href="/"><img src="{% static 'nav_img/logo.png' %}" alt="BEAR logo" class="bear-logo"></a>
    <div class="progress-container"><div class="progress-bar"></div></div>
  </div>

  <div class="card">
    <div class="helper" id="helperText">3개 항목을 선택해주세요</div>

    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    <form method="post" id="prefForm" action="{% url 'accounts_app:signup_step3' %}">
      {% csrf_token %}

      <input type="hidden" name="ratio_carb" id="ratio_carb" value="{{ pref_carb|default:0 }}">
      <input type="hidden" name="ratio_protein" id="ratio_protein" value="{{ pref_protein|default:0 }}">
      <input type="hidden" name="ratio_fat" id="ratio_fat" value="{{ pref_fat|default:0 }}">

      <input type="hidden" name="choice_carb" id="choice_carb" value="{{ choice_carb|default:0 }}">
      <input type="hidden" name="choice_protein" id="choice_protein" value="{{ choice_protein|default:0 }}">
      <input type="hidden" name="choice_fat" id="choice_fat" value="{{ choice_fat|default:0 }}">

      <div class="q-row" data-key="carb">
        <img src="{% static 'settings_img/icon_rice.png' %}" class="q-ico" alt="carb">
        <div>
          <div class="q-title">밥·빵·면 같은 탄수화물 음식을 어느 정도로 즐기나요?</div>
          <div class="tri" role="group" aria-label="carb preference">
            <button type="button" class="tri-btn" data-v="-1">별로</button>
            <button type="button" class="tri-btn is-on" data-v="0">보통</button>
            <button type="button" class="tri-btn" data-v="1">많이</button>
          </div>
        </div>
      </div>

      <div class="q-row" data-key="protein">
        <img src="{% static 'settings_img/icon_shrimp.png' %}" class="q-ico" alt="protein">
        <div>
          <div class="q-title">고기·생선·달걀 같은 단백질 음식을 식사에서 얼마나 중요하게 생각하나요?</div>
          <div class="tri" role="group" aria-label="protein preference">
            <button type="button" class="tri-btn" data-v="-1">별로</button>
            <button type="button" class="tri-btn is-on" data-v="0">보통</button>
            <button type="button" class="tri-btn" data-v="1">많이</button>
          </div>
        </div>
      </div>

      <div class="q-row" data-key="fat">
        <img src="{% static 'settings_img/icon_beef.png' %}" class="q-ico" alt="fat">
        <div>
          <div class="q-title">버터·치즈와 같은 지방 음식을 얼마나 좋아하시나요?</div>
          <div class="tri" role="group" aria-label="fat preference">
            <button type="button" class="tri-btn" data-v="-1">별로</button>
            <button type="button" class="tri-btn is-on" data-v="0">보통</button>
            <button type="button" class="tri-btn" data-v="1">많이</button>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button type="button" class="btn-prev" onclick="history.back()">이전</button>
        <button type="submit" class="btn-next" id="nextBtn" disabled>다음 단계</button>
      </div>
    </form>
  </div>

  <script>
  function choicesToRatios(c, p, f) {
    const weights = [
      { k: "carb",    w: 2 + c },
      { k: "protein", w: 2 + p },
      { k: "fat",     w: 2 + f },
    ];
    const sumW = weights.reduce((a, x) => a + x.w, 0);

    const raws = weights.map((x) => {
      const raw = (10 * x.w) / sumW;
      const flo = Math.floor(raw);
      return { ...x, raw, flo, rem: raw - flo };
    });

    let total = raws.reduce((a, x) => a + x.flo, 0);
    const order = { carb: 0, protein: 1, fat: 2 };
    raws.sort((a, b) => (b.rem - a.rem) || (order[a.k] - order[b.k]));

    let i = 0;
    while (total < 10) {
      raws[i].flo += 1;
      total += 1;
      i = (i + 1) % raws.length;
    }

    const out = { ratio_carb: 0, ratio_protein: 0, ratio_fat: 0 };
    raws.forEach((x) => out[`ratio_${x.k}`] = x.flo);
    return out;
  }

  function ratioToChoice(r) {
    const v = parseInt(r || "0", 10);
    if (v >= 5) return 1;
    if (v <= 2) return -1;
    return 0;
  }

  const form = document.getElementById("prefForm");
  const nextBtn = document.getElementById("nextBtn");
  const helperText = document.getElementById("helperText");

  const ratioInputs = {
    carb: document.getElementById("ratio_carb"),
    protein: document.getElementById("ratio_protein"),
    fat: document.getElementById("ratio_fat"),
  };

  const choiceInputs = {
    carb: document.getElementById("choice_carb"),
    protein: document.getElementById("choice_protein"),
    fat: document.getElementById("choice_fat"),
  };

  const state = {
    carb: ratioToChoice(ratioInputs.carb.value),
    protein: ratioToChoice(ratioInputs.protein.value),
    fat: ratioToChoice(ratioInputs.fat.value),
  };

  let dirty = false;

  function setActiveUI(rowEl, v) {
    const btns = Array.from(rowEl.querySelectorAll(".tri-btn"));
    btns.forEach((b) => {
      const on = String(b.dataset.v) === String(v);
      b.classList.toggle("is-on", on);
      b.setAttribute("aria-pressed", on ? "true" : "false");
    });
  }

  function updateHelperPreview() {
    const preview = choicesToRatios(state.carb, state.protein, state.fat);
    helperText.textContent = `적용 비율(합10): 탄 ${preview.ratio_carb} · 단 ${preview.ratio_protein} · 지 ${preview.ratio_fat}`;
  }

  function syncChoiceHiddenOnly() {
    if (choiceInputs.carb) choiceInputs.carb.value = String(state.carb);
    if (choiceInputs.protein) choiceInputs.protein.value = String(state.protein);
    if (choiceInputs.fat) choiceInputs.fat.value = String(state.fat);
  }

  function syncRatiosIfDirty() {
    if (!dirty) return;
    const ratios = choicesToRatios(state.carb, state.protein, state.fat);
    ratioInputs.carb.value = String(ratios.ratio_carb);
    ratioInputs.protein.value = String(ratios.ratio_protein);
    ratioInputs.fat.value = String(ratios.ratio_fat);
  }

  function allChosen() {
    return ["carb","protein","fat"].every(k => state[k] !== null && state[k] !== undefined);
  }

  function updateNext() {
    nextBtn.disabled = !allChosen();
  }

  document.querySelectorAll(".q-row").forEach((row) => {
    const key = row.dataset.key;
    setActiveUI(row, state[key]);

    row.querySelectorAll(".tri-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const v = parseInt(btn.dataset.v, 10);
        state[key] = v;

        dirty = true;
        setActiveUI(row, v);

        syncChoiceHiddenOnly();
        syncRatiosIfDirty();
        updateHelperPreview();
        updateNext();
      });
    });
  });

  syncChoiceHiddenOnly();
  updateHelperPreview();
  updateNext();

  form.addEventListener("submit", (e) => {
    dirty = true;
    syncRatiosIfDirty();

    const c = parseInt(ratioInputs.carb.value || "0", 10);
    const p = parseInt(ratioInputs.protein.value || "0", 10);
    const f = parseInt(ratioInputs.fat.value || "0", 10);

    if (c + p + f !== 10) {
      e.preventDefault();
      helperText.textContent = "오류: 합계가 10이 되지 않았습니다. 다시 선택해주세요.";
    }
  });
  </script>
</body>
</html>