{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/timeline.css' %}">
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
{% endblock %}

{% block content %}

<!-- jQuery & Datepicker -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.ko.min.js"></script>


<div class="settings-page timeline-page">
  <!-- (1) ML ì˜¤ëŠ˜ì˜ ê°ì • ì˜ˆì¸¡ ê²°ê³¼ -->
  <section class="timeline-section">
    <div class="timeline-card">
      <div class="timeline-card-inner">

        {# âœ… ê¸°ì¡´ timeline-card-head ì œê±° #}

        {% if not neg_pred.eligible %}
          <div class="negpred-wrap">

            <div class="negpred-panel negpred-panel--empty">

              {# âœ… í° ë°•ìŠ¤ ì•ˆìœ¼ë¡œ ì´ë™ #}
              <h4 class="timeline-title timeline-title--inside negpred-title-inpanel">
                ì˜¤ëŠ˜ì˜ ê°ì • ì˜ˆì¸¡
              </h4>

              <div class="negpred-empty-text">
                <p class="negpred-empty-title">âš ï¸ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤</p>
                <p class="negpred-empty-desc">
                  {% if neg_pred.detail.type == "no_recent_record" %}
                    ì•„ë˜ ë‚ ì§œì— ê°ì • ê¸°ë¡ì´ ì—†ì–´ ì˜ˆì¸¡í•  ìˆ˜ ì—†ì–´
                  {% else %}
                    í‚¤ì›Œë“œ ì…ë ¥ì´ ì—†ëŠ” ë‚ ì§œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
                  {% endif %}
                </p>

                {% if neg_pred.detail.type == "gate_keyword_3days" or neg_pred.detail.type == "no_recent_record" %}
                  <p class="negpred-empty-dates">
                    {{ neg_pred.detail.missing_days|join:", " }}
                  </p>
                {% endif %}
              </div>

            </div>
          </div>

        {% else %}
          <div class="negpred-wrap">

            <div class="negpred-panel">

              {# âœ… í° ë°•ìŠ¤ ì•ˆìœ¼ë¡œ ì´ë™ #}
              <h4 class="timeline-title timeline-title--inside negpred-title-inpanel">
                ì˜¤ëŠ˜ì˜ ê°ì • ì˜ˆì¸¡
              </h4>

              <div class="negpred-icons" aria-label="ë¶€ì • ê°ì • ì˜ˆì¸¡ ì•„ì´ì½˜">
                <!-- ê¸ì • -->
                <div class="negpred-item {% if neg_pred.ui_active_idx == 0 %}is-active{% endif %}">
                  <img src="{% static 'icons_img/ê¸ì •.png' %}" alt="Positive(ê¸ì •)" class="negpred-img" />
                  {% if neg_pred.ui_active_idx == 0 %}
                    <p class="negpred-status">{{ neg_pred.ui_status_text }}</p>
                  {% endif %}
                </div>

                <!-- ì¤‘ë¦½ -->
                <div class="negpred-item {% if neg_pred.ui_active_idx == 1 %}is-active{% endif %}">
                  <img src="{% static 'icons_img/ì¤‘ë¦½.png' %}" alt="Neutral(ì¤‘ë¦½)" class="negpred-img" />
                  {% if neg_pred.ui_active_idx == 1 %}
                    <p class="negpred-status">{{ neg_pred.ui_status_text }}</p>
                  {% endif %}
                </div>

                <!-- ë¶€ì • -->
                <div class="negpred-item {% if neg_pred.ui_active_idx == 2 %}is-active{% endif %}">
                  <img src="{% static 'icons_img/ë¶€ì •.png' %}" alt="Negative(ë¶€ì •)" class="negpred-img" />
                  {% if neg_pred.ui_active_idx == 2 %}
                    <p class="negpred-status">{{ neg_pred.ui_status_text }}</p>
                  {% endif %}
                </div>
              </div>

            </div>
          </div>
        {% endif %}


      </div>
    </div>
  </section>


  <!-- (2) LLM ë©˜íŠ¸ -->
  <section class="timeline-section">
    <div class="timeline-card">
      <div class="timeline-card-inner">

        {# âœ… ê¸°ì¡´ timeline-card-head ì œê±° #}

        {% if not neg_pred.eligible %}
          <div class="llm-box is-empty llm-box--titled">
            <h4 class="timeline-title timeline-title--inside">í–‰ë™ ì¶”ì²œ</h4>
            <p class="llm-text">ê°ì • ì˜ˆì¸¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>

        {% elif not llm_ment %}
          <div class="llm-box is-empty llm-box--titled">
            <h4 class="timeline-title timeline-title--inside">í–‰ë™ ì¶”ì²œ</h4>
            <p class="llm-text">í–‰ë™ ì¶”ì²œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>

        {% else %}
          <div class="llm-box llm-box--titled {% if neg_pred.ui_active_idx == 2 %}is-risk{% endif %}">
            <h4 class="timeline-title timeline-title--inside">í–‰ë™ ì¶”ì²œ</h4>
            <p class="llm-text">{{ llm_ment }}</p>
          </div>
        {% endif %}

      </div>
    </div>
  </section>



  <!-- (3) ëˆ„ì ë§‰ëŒ€ê·¸ë˜í”„ -->
  <section class="timeline-section">
    <div class="timeline-card">
      <div class="timeline-card-inner">

        {# âœ… ê¸°ì¡´ timeline-card-head timeline-card-head--stack ì œê±° #}

        <div class="timeline-chart-panel">

          {# âœ… íŒ¨ë„ ë‚´ë¶€ í—¤ë” ì¶”ê°€ (íƒ€ì´í‹€+datebar ëª¨ë‘ ì•ˆìœ¼ë¡œ) #}
          <div class="timeline-chart-head" id="week-picker-trigger">
            <h4 class="timeline-title timeline-title--inside">ê°ì • ë³€í™” ìš”ì•½</h4>

            <div class="timeline-datebar">
              <span class="timeline-datebar-icon">ğŸ“…</span>
              <span class="timeline-datebar-text" id="week-picker-label">
                {{ week_start }} ~ {{ week_end }}
              </span>
              <span class="timeline-datebar-caret">â–¾</span>
              <input type="text" id="week-picker" class="timeline-week-hidden-input" readonly>
            </div>
          </div>

          <div class="timeline-canvas-wrap">
            <canvas id="weeklyEmotionChart"></canvas>
          </div>

          <div class="timeline-xlabels" id="weeklyDateLabels" aria-hidden="true"></div>
        </div>

      </div>
    </div>
  </section>
</div>


<!-- âœ… Chart data -->
<script id="weeklyEmotionData" type="application/json">
{{ chart_json|safe }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/timeline.js' %}"></script>

<!-- âœ… Week Datepicker Script -->
<script>
$(function () {
    const weekStartStr = "{{ week_start }}"; // YYYY.MM.DD
    const weekEndStr   = "{{ week_end }}";

    // ë¼ë²¨ ì´ˆê¸° í‘œì‹œ
    $('#week-picker-label').text(`${weekStartStr} ~ ${weekEndStr}`);

    const today = new Date();
    const maxStart = new Date();
    maxStart.setDate(today.getDate() - 6); // (A-1) ì˜¤ëŠ˜-6ê¹Œì§€ë§Œ ì‹œì‘ ê°€ëŠ¥

    $('#week-picker').datepicker({
        format: 'yyyy-mm-dd',
        language: 'ko',
        autoclose: true,
        endDate: maxStart,
        todayHighlight: false
    }).on('changeDate', function (e) {
        const startDate = e.date;
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);

        const fmt = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}${m}${day}`;
        };

        // ë¼ë²¨(í™”ë©´í‘œì‹œ)ì€ YYYY.MM.DD ~ YYYY.MM.DD í˜•íƒœ ìœ ì§€
        const fmtLabel = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}.${m}.${day}`;
        };
        $('#week-picker-label').text(`${fmtLabel(startDate)} ~ ${fmtLabel(endDate)}`);

        const startParam = fmt(startDate);
        const endParam = fmt(endDate);

        // í™”ë©´ ê°±ì‹ (ê°™ì€ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë§Œ ë°”ë€ŒëŠ” ëŠë‚Œ)
        window.location.search = `?start=${startParam}&end=${endParam}`;
    });

    // âœ… ë°” ì „ì²´ í´ë¦­ ì‹œ ë‹¬ë ¥ ì—´ê¸°
    $('#week-picker-trigger').on('click', function () {
        $('#week-picker').datepicker('show');
    });
});
</script>


{% endblock %}
